# Subei Fault System Meshing (Development Version)

This directory contains the development version of the meshing system for the Subei fault system used in EQdyna.2Dcycle earthquake dynamics simulations.

## Overview

The meshing system generates 2D finite element meshes for complex fault systems using GMSH, then processes them for use with the EQdyna.2Dcycle simulation engine. It handles fault geometry, creates split nodes for fault interfaces, and assigns physics parameters.

## Fault System Description

The **Subei fault system** consists of four fault segments:
- **atf1** & **atf2**: Main thrust fault segments (connected)
- **dxs**: Detachment fault segment  
- **sbt**: Secondary branch fault segment

These faults interact in a complex geometric arrangement that requires specialized meshing to handle fault intersections and split nodes.

## Files and Structure

### Input Files
```
user_fault_geometry_input/
├── atf1.gmt.txt          # Fault geometry: ATF segment 1
├── atf2.gmt.txt          # Fault geometry: ATF segment 2  
├── dxs.gmt.txt           # Fault geometry: Detachment segment
└── sbt.gmt.txt           # Fault geometry: Secondary branch

user_defined_params.py    # EQdyna simulation parameters
userDefinedFaultSysGeoPhys.py  # Fault physics definitions
```

### Meshing Tools
```
meshGen.test.subei.ipynb  # Interactive Jupyter notebook (recommended)
meshGen.test.subei.py     # Python script version
meshGenLib.py             # Meshing utility library
```

### Output Files
```
fem_mesh_output/
├── vert.txt              # Node coordinates (~13,869 nodes) - USED BY FORTRAN
├── fac.txt               # Element connectivity (~13,495 elements) - USED BY FORTRAN  
├── nsmp.txt              # Fault node mapping (615 fault segments) - USED BY FORTRAN
├── nsmpGeoPhys.txt       # Fault physics parameters (615 entries) - USED BY FORTRAN
├── meshGeneralInfo.txt   # Mesh statistics - USED BY FORTRAN
├── nsmpTanLen.txt        # Fault tangent and length data - Python only
├── eqdynaMesh.msh        # GMSH mesh file - Python only
├── meshWOSplitNode.png   # Mesh before fault processing - Visualization
└── meshWithFaultNodes.png # Mesh with fault nodes highlighted - Visualization

misc/
├── FE_Global.txt         # Global simulation parameters (example)
├── FE_Model_Geometry.txt # Model geometry settings (example)  
└── FE_Fault_Geometry.txt # Fault geometry settings (example)

# Additional files for EQdyna simulation (generated separately):
# Rate_direction.txt       # Loading directions - REQUIRED by Fortran (conditional)
# FE_*.txt                 # Configuration files - generated by case.setup  
```

## Usage

### Option 1: Jupyter Notebook (Recommended)
```bash
# Open interactive notebook
jupyter notebook meshGen.test.subei.ipynb

# Run all cells step by step to:
# 1. Load fault geometry from user_fault_geometry_input/
# 2. Generate GMSH mesh
# 3. Process fault interfaces  
# 4. Create split nodes
# 5. Export EQdyna files to fem_mesh_output/
# 6. Generate visualizations
```

### Option 2: Python Script
```bash
# Run complete meshing pipeline
python3 meshGen.test.subei.py

# All outputs automatically organized:
# - Reads from: user_fault_geometry_input/
# - Writes to: fem_mesh_output/
```

## Meshing Process

### 1. Geometry Setup
- Load fault traces from `user_fault_geometry_input/*.gmt.txt`
- Define model boundaries with buffer zones
- Set mesh resolution (`dx = 0.5` km near faults)

### 2. GMSH Mesh Generation
- Create fault lines and model boundaries
- Define surfaces between fault segments
- Generate quadrilateral finite element mesh
- Apply mesh refinement near fault zones

### 3. Fault Interface Processing
- Locate fault nodes in the mesh
- Create "split nodes" for fault interfaces
- Identify elements above/below each fault
- Replace master nodes with slave nodes for proper fault mechanics

### 4. Element Processing
- Reorder element nodes counterclockwise
- Ensure proper element orientation
- Calculate fault tangent vectors and segment lengths

### 5. Physics Assignment
- Assign material properties to fault segments
- Define friction parameters
- Set initial stress conditions

### 6. File Export
- Generate EQdyna input files in `fem_mesh_output/`
- Create visualization plots (`*.png` files)  
- Export mesh statistics (`meshGeneralInfo.txt`)

## Key Parameters

### Mesh Resolution
```python
dx = 0.5              # Fault zone mesh size (km)
dxAtBoundary = 20     # Boundary mesh size (km)  
totalSimuTime = 15    # Simulation time for boundary sizing
```

### Model Dimensions
- **Fault system extent**: ~80 km × 25 km
- **Model boundaries**: Extended for wave absorption
- **Total nodes**: ~13,869
- **Total elements**: ~13,495 quadrilaterals

### Fault Discretization
- **Total fault segments**: 615
- **Fault node spacing**: ~0.5 km
- **Split node implementation**: Yes (for fault slip)

## Dependencies

### Required Python Packages
```bash
pip install numpy matplotlib meshio gmsh
```

### System Requirements
- **GMSH**: Mesh generation library
- **Python 3.7+**: With scientific computing packages
- **Memory**: ~2GB for mesh processing
- **Storage**: ~100MB for output files

## Output Validation

### Mesh Quality Checks
- **Element aspect ratios**: Monitored during generation
- **Fault node alignment**: Verified against input geometry  
- **Split node correspondence**: Master-slave relationships checked
- **Element orientation**: Counterclockwise node ordering enforced

### Comparison with Reference
```bash
# Current mesh statistics
Nodes: 13,869 (vs 13,862 reference)
Elements: ~13,495 quadrilaterals  
Fault segments: 615
```

## Troubleshooting

### Common Issues
1. **Import errors**: Ensure `meshGenLib.py` is in working directory
2. **GMSH not found**: Install via `pip install gmsh`
3. **Memory errors**: Reduce mesh resolution (`dx` parameter)
4. **Visualization issues**: Set `debugMode = True` for plots

### Debug Mode
```python
# Enable debugging in meshGen script
debugMode = True

# Provides:
# - Detailed console output
# - Intermediate plots
# - Mesh quality statistics
```

## Development Notes

### Recent Improvements
- **Organized folder structure**: Separated inputs and outputs
- **Cleaned meshing workflow**: Removed v2 suffixes  
- **Input organization**: `user_fault_geometry_input/` folder
- **Output organization**: `fem_mesh_output/` folder
- **Improved documentation**: Updated file structure guide

### Future Enhancements
- Adaptive mesh refinement
- Alternative fault geometries
- Improved mesh quality optimization
- Parallel mesh generation support

## References

For details on the finite element method and fault mechanics implementation, see:
- EQdyna.2Dcycle main documentation
- GMSH documentation: https://gmsh.info/
- Fault system geology: Subei basin structural geology

---

**Last Updated**: February 2025  
**Mesh Version**: 2.0.4  
**Compatible with**: EQdyna.2Dcycle v2.0.4+